<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SecureVault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="container nav-content">
            <a href="index.html" class="logo">
                <i class="fas fa-shield-alt"></i> SecureVault
            </a>
            <button id="nav-toggle" aria-label="Abrir Menu">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="index.html">Início</a></li>
                    <li><a href="funcionalidades.html">Recursos</a></li>
                    <li><a href="precos.html">Preços</a></li>
                    <li><a href="suporte.html">Suporte</a></li>
                    <li><a href="#" id="logout-btn" class="btn btn-primary">Sair</a></li>
                </ul>
            </nav>
            <button id="theme-toggle-btn" aria-label="Alternar Tema">
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </header>

    <main class="container">
        <section class="hero" style="text-align: center; padding: 50px 0;">
            <h1>Bem-vindo, <span id="user-name">Usuário</span>!</h1>
            <p id="plan-info" style="font-size: 1.2rem; margin: 10px 0;">Plano: Carregando...</p>

            <div style="max-width: 600px; margin: 20px auto;">
                <div class="progress-bar" style="background: var(--color-border); height: 14px; border-radius: 8px; overflow: hidden;">
                    <div id="storage-progress" style="width: 0%; height: 100%; background: var(--color-primary); transition: width 0.8s ease;"></div>
                </div>
                <p id="storage-text" style="text-align: center; margin-top: 8px; color: var(--color-secondary);">0 GB de 5 GB usados</p>
            </div>
        </section>

        <div class="features-grid">
            <div class="card feature-item">
                <div class="icon"><i class="fas fa-cloud-upload-alt"></i></div>
                <h3>Enviar Arquivo Seguro</h3>
                <p>Seus arquivos são enviados com segurança total.</p>
                <input type="file" id="fileInput" style="margin: 15px 0; width: 100%;">
                <button id="uploadBtn" class="btn btn-primary" style="width: 100%;">Fazer Upload</button>
                <p id="uploadFeedback" style="margin-top: 12px; min-height: 28px; font-weight: bold;"></p>
            </div>

            <div class="card feature-item">
                <div class="icon"><i class="fas fa-shield-alt"></i></div>
                <h3>Segurança Máxima</h3>
                <p>Autenticação JWT + controle de acesso por plano.</p>
                <p>Nenhum dado fica no navegador.</p>
            </div>
        </div>

        <div class="card" style="margin-top: 40px;">
            <h3><i class="fas fa-folder-open"></i> Meus Arquivos</h3>
            <div id="fileList" style="margin-top: 20px;">
                <p style="text-align:center; color: var(--color-secondary);">Carregando arquivos...</p>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>© 2025 SecureVault. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module" src="js/main.js"></script>
    <script type="module">
        import { getMe, getFiles, uploadFile, deleteFile } from './js/api.js';
        import { logout, getCurrentUser } from './js/auth.js';

        const user = getCurrentUser();
        if (user) {
            document.getElementById('user-name').textContent = user.name.split(' ')[0] || 'Usuário';
            document.getElementById('plan-info').textContent = `Plano: ${user.plano || 'Básico'}`;
        }

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return alert('Selecione um arquivo!');

            const feedback = document.getElementById('uploadFeedback');
            feedback.textContent = 'Enviando...';
            feedback.style.color = 'var(--color-primary)';

            try {
                await uploadFile(file);
                feedback.textContent = 'Upload concluído com sucesso!';
                feedback.style.color = 'var(--color-accent)';
                fileInput.value = '';
                loadFiles();
                updateStorageBar();
            } catch (err) {
                feedback.textContent = `Erro: ${err.message}`;
                feedback.style.color = 'red';
            }
        });

        async function loadFiles() {
            try {
                const files = await getFiles();
                const list = document.getElementById('fileList');

                if (files.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--color-secondary);">Nenhum arquivo enviado ainda.</p>';
                    return;
                }

                list.innerHTML = files.map(f => `
                    <div style="padding:15px; border-bottom:1px solid var(--color-border); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <i class="fas fa-file" style="margin-right:8px;"></i>
                            <strong>${f.name}</strong>
                            <small style="color:var(--color-secondary); margin-left:10px;">
                                ${ (f.size / 1024 / 1024).toFixed(2) } MB · ${new Date(f.uploadedAt).toLocaleDateString('pt-BR')}
                            </small>
                        </div>
                        <div>
                            <a href="http://localhost:5000/uploads/${f.filename}" target="_blank" class="btn-download">
                                Download
                            </a>
                            <button onclick="confirmDelete('${f.id}')" class="btn-delete">Excluir</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('fileList').innerHTML = '<p style="color:red;">Erro ao carregar arquivos.</p>';
            }
        }

        window.confirmDelete = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este arquivo permanentemente?')) return;
            try {
                await deleteFile(id);
                alert('Arquivo excluído!');
                loadFiles();
                updateStorageBar();
            } catch (err) {
                alert('Erro ao excluir: ' + err.message);
            }
        };

        async function updateStorageBar() {
            try {
                const data = await getMe();
                const usedGB = (data.user.storageUsed / (1024**3)).toFixed(2);
                const limitGB = data.user.plano === 'Pro' ? 50 : data.user.plano === 'Empresarial' ? 9999 : 5;
                const percent = Math.min((data.user.storageUsed / (limitGB * 1024**3)) * 100, 100);

                document.getElementById('storage-progress').style.width = percent + '%';
                document.getElementById('storage-text').textContent = `${usedGB} GB de ${limitGB} GB usados`;
            } catch (err) {
                console.error('Erro ao atualizar barra:', err);
            }
        }

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });

        loadFiles();
        updateStorageBar();
    </script>
</body>
</html>